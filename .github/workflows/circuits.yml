name: Circom Circuits

on:
  push:
    branches: [main, develop, feat/**]
    paths:
      - 'zylith/circom/**'
      - '.github/workflows/circuits.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'zylith/circom/**'
      - '.github/workflows/circuits.yml'

jobs:
  compile-circuits:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./zylith/circom

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./zylith/circom/package.json

      - name: Install Circom
        run: |
          wget https://github.com/iden3/circom/releases/download/v2.1.6/circom-linux-amd64
          chmod +x circom-linux-amd64
          sudo mv circom-linux-amd64 /usr/local/bin/circom

      - name: Verify Circom installation
        run: circom --version

      - name: Install npm dependencies
        run: npm ci

      - name: Cache circuit builds
        uses: actions/cache@v4
        with:
          path: |
            ./zylith/circom/build
            ./zylith/circom/pot
            ./zylith/circom/zkeys
          key: ${{ runner.os }}-circuits-${{ hashFiles('**/circuits/*.circom') }}
          restore-keys: |
            ${{ runner.os }}-circuits-

      - name: Compile circuits
        run: npm run compile

      - name: Upload circuit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: circuit-builds
          path: |
            ./zylith/circom/build/
          retention-days: 7

  # Note: This job is commented out as it's very resource-intensive
  # Uncomment when ready to generate keys in CI
  # generate-keys:
  #   runs-on: ubuntu-latest
  #   needs: compile-circuits
  #   defaults:
  #     run:
  #       working-directory: ./zylith/circom
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #
  #     - name: Install npm dependencies
  #       run: npm ci
  #
  #     - name: Download circuit builds
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: circuit-builds
  #         path: ./zylith/circom/build/
  #
  #     - name: Generate trusted setup
  #       run: npm run setup
  #
  #     - name: Generate verification keys
  #       run: npm run generate-keys
  #
  #     - name: Export verification keys
  #       run: npm run export-vk
  #
  #     - name: Upload verification keys
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: verification-keys
  #         path: ./zylith/circom/vkeys/
  #         retention-days: 30
