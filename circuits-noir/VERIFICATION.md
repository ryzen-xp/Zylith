# Starknet Verification Guide for Noir Circuits

This guide documents the complete workflow for verifying Noir UltraHonk proofs on Starknet using Garaga (Phase 4 research).

## Overview

**Great News**: Garaga fully supports Noir UltraHonk verification on Starknet! As of May 2025, Garaga enables anyone using Noir to verify proofs on Starknet without writing any Cairo code manually.

## Why Garaga + UltraHonk?

### Advantages

1. **No Trusted Setup**: UltraHonk uses PLONK backend (no toxic waste)
2. **Automatic Verifier Generation**: Garaga generates Cairo contracts from your circuits
3. **Lower Costs**: Starknet offers significantly lower transaction fees than mainnet L1
4. **Faster Processing**: Efficient verification leveraging Starknet's native capabilities
5. **Production Ready**: Used in live Starknet applications

### Technical Stack

- **Proving System**: UltraHonk (PLONK variant)
- **Hash**: Keccak oracle (specified with `--oracle_hash keccak`)
- **Backend**: Barretenberg 3.0.0-nightly.20251104
- **Verifier Generator**: Garaga SDK 1.0.1
- **Target**: Starknet Cairo contracts

## Prerequisites

### Required Software

| Tool | Version | Status | Notes |
|------|---------|--------|-------|
| **Python 3.10** | 3.10.19 | ✅ Installed | Via pyenv |
| **Nargo** | 1.0.0-beta.16+ | ✅ Installed | Current: 1.0.0-beta.17 |
| **Barretenberg** | 3.0.0-nightly.20251104 | ✅ Installed | Exact match! |
| **Garaga CLI** | 1.0.1 | ✅ Installed | In Python 3.10 venv |

### Environment Setup

**Garaga Virtual Environment**:
A dedicated Python 3.10 virtual environment has been created at `.venv-garaga/` because Garaga requires Python 3.10.x specifically.

**Activate the Garaga environment**:
```bash
# From the project root
source activate-garaga.sh

# Or manually
source .venv-garaga/bin/activate
```

**Verify installation**:
```bash
garaga --version  # Should show: garaga version: 1.0.1
python --version  # Should show: Python 3.10.19
```

**Important**: Always activate the Garaga environment before running Garaga commands.

## Verification Workflow

### Step 1: Compile Noir Circuit

```bash
cd circuits-noir/membership
nargo compile
```

Generates: `target/membership.json`

### Step 2: Generate Verification Key

Use Barretenberg with UltraHonk + Keccak:

```bash
bb write_vk \\
  -s ultra_honk \\
  --oracle_hash keccak \\
  -b target/membership.json \\
  -o target/vk
```

**Key Points**:
- `ultra_honk`: Specifies the proving system
- `--oracle_hash keccak`: Required for Starknet compatibility
- ZK mode is enabled by default
- VK is the same for ZK and non-ZK proofs

Generates: `target/vk`

### Step 3: Generate Cairo Verifier Contract

```bash
garaga gen \\
  --system ultra_keccak_zk_honk \\
  --vk target/vk
```

**Outputs**:
- `honk_verifier.cairo`: Main verifier contract
- Cairo project structure ready for deployment
- Interface: `IUltraKeccakZKHonkVerifier`

**Important**: The generated contract is compatible with Starknet's Cairo VM.

### Step 4: Create Test Proof

Configure inputs in `Prover.toml`, then:

```bash
# Generate witness
nargo execute witness

# Generate proof
bb prove \\
  -s ultra_honk \\
  --oracle_hash keccak \\
  -b target/membership.json \\
  -w target/witness.gz \\
  -o target/
```

Generates:
- `target/proof`: The zero-knowledge proof
- `target/public_inputs`: Public inputs for verification

### Step 5: Generate Calldata for Starknet

```bash
garaga calldata \\
  --system ultra_keccak_zk_honk \\
  --proof target/proof \\
  --vk target/vk \\
  --public-inputs target/public_inputs
```

**Critical**: Use the same Garaga SDK version that generated your verifier contract. Version mismatches cause verification failures.

**Output**: Calldata formatted for Starknet contract calls

### Step 6: Deploy Verifier to Starknet

```bash
# Declare the contract
garaga declare

# Deploy using the class hash
garaga deploy

# Verify a proof on-chain
garaga verify-onchain
```

**Alternative**: Use Starknet CLI tools for manual deployment control.

## File Structure

After generating verifiers, your project structure will be:

```
circuits-noir/
├── membership/
│   ├── src/
│   │   └── main.nr              # Noir circuit
│   ├── target/
│   │   ├── membership.json      # Compiled circuit
│   │   ├── membership.gz        # Witness
│   │   ├── vk                   # Verification key
│   │   ├── proof                # ZK proof
│   │   └── public_inputs        # Public inputs
│   ├── verifier/                # Generated by Garaga
│   │   ├── honk_verifier.cairo  # Main verifier contract
│   │   └── ...                  # Supporting Cairo files
│   ├── Nargo.toml
│   └── Prover.toml
├── swap/
│   └── [same structure]
├── withdraw/
│   └── [same structure]
├── lp_mint/
│   └── [same structure]
└── lp_burn/
    └── [same structure]
```

## Integration with Zylith Cairo Contracts

### Verifier Interface

The generated Cairo contract implements:

```cairo
#[starknet::interface]
trait IUltraKeccakZKHonkVerifier<TContractState> {
    fn verify_proof(
        ref self: TContractState,
        proof: Span<felt252>,
        public_inputs: Span<felt252>
    ) -> bool;
}
```

### Zylith Integration Pattern

In your main Zylith CLMM contract:

```cairo
use verifier::IUltraKeccakZKHonkVerifierDispatcher;
use verifier::IUltraKeccakZKHonkVerifierDispatcherTrait;

#[storage]
struct Storage {
    membership_verifier: ContractAddress,
    swap_verifier: ContractAddress,
    withdraw_verifier: ContractAddress,
    lp_mint_verifier: ContractAddress,
    lp_burn_verifier: ContractAddress,
}

fn private_swap(
    ref self: ContractState,
    proof: Span<felt252>,
    public_inputs: Span<felt252>,
    // ... other params
) {
    // Verify the proof
    let verifier = IUltraKeccakZKHonkVerifierDispatcher {
        contract_address: self.swap_verifier.read()
    };

    let is_valid = verifier.verify_proof(proof, public_inputs);
    assert(is_valid, 'Invalid swap proof');

    // Execute swap logic...
}
```

## Gas Cost Considerations

### Verification Costs (Estimated)

| Circuit | Constraints | Est. Gas Cost | Notes |
|---------|-------------|---------------|-------|
| Membership | ~500 | Low | Simple Merkle proof |
| Swap | ~2000 | Medium | CLMM math validation |
| Withdraw | ~800 | Low | Nullifier + Merkle |
| LP Mint | ~1500 | Medium | Liquidity calculations |
| LP Burn | ~1500 | Medium | Similar to mint |

**Note**: Actual costs depend on:
- Starknet gas prices
- Circuit complexity after full CLMM math implementation
- Proof aggregation strategies

### Optimization Strategies

1. **Proof Aggregation**: Batch multiple proofs into one verification
2. **Recursive Proofs**: Prove proof verification off-chain
3. **Circuit Optimization**: Minimize constraint count in Noir
4. **Shared Verifiers**: Reuse verifiers for similar circuit structures

## Security Considerations

### Verifier Security

1. **Audit Generated Code**: Review Garaga-generated Cairo contracts
2. **Test Extensively**: Verify with both valid and invalid proofs
3. **Version Pinning**: Lock Garaga SDK version in production
4. **Upgrade Path**: Plan for verifier contract upgrades

### Integration Security

1. **Public Input Validation**: Verify public inputs match expected format
2. **Nullifier Tracking**: Prevent double-spending in withdraw/swap
3. **Merkle Root Management**: Ensure root updates are authorized
4. **Access Control**: Restrict who can update verifier addresses

## Testing Strategy

### Local Testing

1. **Generate test proofs** with known inputs
2. **Verify locally** using `bb verify`
3. **Generate calldata** and test contract calls
4. **Test invalid proofs** to ensure rejection

### Devnet Testing

1. **Deploy to local Starknet devnet**
2. **Submit valid proofs** and verify success
3. **Submit invalid proofs** and verify rejection
4. **Measure gas costs** for each circuit type
5. **Test edge cases** (boundary values, malformed inputs)

### Testnet Testing

1. **Deploy to Sepolia/Goerli Starknet testnet**
2. **End-to-end user flow testing**
3. **Performance benchmarking**
4. **Stress testing** with multiple concurrent proofs

## Deployment Checklist

- [x] Python 3.10+ environment set up ✅ (Python 3.10.19 via pyenv)
- [x] Garaga CLI installed and verified ✅ (v1.0.1 in .venv-garaga/)
- [ ] All circuits compiled successfully (ready to do)
- [ ] Verification keys generated for all circuits (ready to do)
- [ ] Cairo verifier contracts generated (ready to do)
- [ ] Verifier contracts audited
- [ ] Local testing complete
- [ ] Devnet testing complete
- [ ] Testnet deployment successful
- [ ] Gas costs analyzed and acceptable
- [ ] Security review complete
- [ ] Mainnet deployment plan approved

## Known Limitations & Future Work

### Current Limitations

1. **CLMM Math**: Circuits use simplified checks (full Q96 math TODO)
2. **No Aggregation**: Each proof verified individually
3. **Manual Deployment**: No automated CI/CD pipeline yet

### Future Enhancements

1. **Proof Aggregation**: Implement batch verification
2. **Recursive Proofs**: Verify proofs of proof verification
3. **Automated Deployment**: CI/CD pipeline for verifier updates
4. **Full CLMM Math**: Complete Q96 arithmetic in circuits
5. **Gas Optimization**: Circuit-specific optimizations
6. **Multi-Network**: Deploy to multiple Starknet networks

## References

- [Garaga Documentation](https://garaga.gitbook.io/garaga/)
- [Garaga GitHub Repository](https://github.com/keep-starknet-strange/garaga)
- [Noir on Starknet Blog Post](https://www.starknet.io/blog/noir-on-starknet/)
- [Barretenberg Documentation](https://barretenberg.aztec.network/docs)
- [Starknet Documentation](https://docs.starknet.io/)

## Support & Community

- **Garaga Discord**: Join the Starknet community
- **GitHub Issues**: Report bugs or request features
- **Starknet Forum**: Community discussions and help

---

**Status**: ✅ Environment ready! Python 3.10.19 and Garaga 1.0.1 installed. Ready to generate verifiers.
